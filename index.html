<!DOCTYPE html>
<html lang='vi'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no'>
    <title>Shopee WMS Pro v6.1</title>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css' rel='stylesheet'>
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css'>
    <script src='https://unpkg.com/vue@3/dist/vue.global.js'></script>
    <style>
        html, body {
            height: 100%;
            overflow: hidden;
            background-color: #f4f6f8 ;
            font-size: 14px;
            font-family: -apple-system, sans-serif;
            user-select: none;
        }

        #app {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .scroll-area {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 80px;
            -webkit-overflow-scrolling: touch;
            position: relative;
            z-index: 1;
            scroll-behavior: smooth;
        }

        .main-header {
            transition: margin-top 0.4s cubic-bezier(0.25, 0.8, 0.5, 1);
            will-change: margin-top;
            overflow: visible !important;
            z-index: 1000;
            position: relative;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
        }

        .pull-refresh-loader {
            height: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e9ecef;
            color: #6c757d;
            font-weight: bold;
            transition: height 0.2s ease-out;
        }

            .pull-refresh-loader.refreshing {
                height: 50px !important;
                transition: height 0.2s;
            }

        .pull-icon {
            transition: transform 0.3s;
            font-size: 1.5rem;
            margin-right: 8px;
        }

            .pull-icon.rotate {
                transform: rotate(180deg);
            }

        .spin-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        .card-item {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 10px;
            border: 1px solid #eee;
            overflow: hidden;
        }

        .card-body-custom {
            padding: 12px;
            display: flex;
            align-items: flex-start;
            position: relative;
        }

        .img-box {
            position: relative;
            width: 90px;
            height: 90px;
            flex-shrink: 0;
            margin-right: 12px;
            cursor: pointer;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #eee;
        }

        .img-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .zoom-icon {
            position: absolute;
            bottom: 0;
            right: 0;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 4px 0 0 0;
            pointer-events: none;
        }

        .info-box {
            flex-grow: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }

        .product-name {
            font-weight: 700;
            color: #222;
            margin-bottom: 4px;
            line-height: 1.3;
            font-size: 13px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .variation-badge {
            font-size: 12px;
            color: #e65100;
            background: #fff3e0;
            border: 1px solid #ffe0b2;
            padding: 2px 6px;
            border-radius: 4px;
            width: fit-content;
            margin-bottom: 2px;
            font-weight: 500;
        }

        .location-badge {
            font-size: 11px;
            color: #1565c0;
            background: #e3f2fd;
            padding: 2px 8px;
            border-radius: 4px;
            width: fit-content;
            font-weight: bold;
            border: 1px solid #bbdefb;
            margin-top: 2px;
        }

        .qty-box {
            text-align: right;
            padding-left: 8px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 40px;
        }

        .qty-text {
            font-size: 25px;
            font-weight: 700;
            color: #333;
        }

            .qty-text.red {
                color: #db0606;
            }

        .order-header {
            padding: 12px;
            background: white;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }

            .order-header.active {
                background: #e3f2fd;
                border: 2px solid #90caf9;
                border-left: 5px solid #0d6efd;
                margin-bottom: 0;
                border-radius: 4px 4px 0 0;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }

        .highlight-sn {
            color: #0000ff;
            font-weight: 900;
            background: #ffffff;
            padding: 0 2px;
            border-radius: 2px;
        }

        .order-detail-box {
            background: #f8f9fa;
            border: 2px solid #90caf9;
            border-top: none;
            border-radius: 0 0 4px 4px;
            padding: 10px;
            margin-bottom: 10px;
            border-left: 5px solid #0d6efd;
        }

        .picking-group-header {
            background: #ff9800;
            color: white;
            padding: 8px 12px;
            font-weight: bold;
            border-radius: 6px;
            margin-top: 15px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .picking-card.done {
            opacity: 0.4;
            filter: grayscale(100%);
        }

        .picking-card.highlight-error {
            border: 2px solid #dc3545;
            background-color: #fff5f5;
        }

        .console-box {
            background: #1e1e1e;
            color: #00ff00;
            font-family: monospace;
            padding: 10px;
            border-radius: 6px;
            height: 400px;
            overflow-y: auto;
            font-size: 12px;
            border: 1px solid #444;
        }

        .log-line {
            border-bottom: 1px solid #333;
            padding: 2px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .note-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            margin-top: 4px;
            display: inline-block;
            font-weight: bold;
        }

            .note-badge.normal {
                background: #ffecb3;
                color: #856404;
                border: 1px solid #ffeeba;
            }

            .note-badge.green {
                background: #e8f5e9;
                color: #2e7d32;
                border: 1px solid #c8e6c9;
            }

            .note-badge.red {
                background: #ffebee;
                color: #c62828;
                border: 1px solid #ffcdd2;
            }

        .btn-float-bottom {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 30%;
            max-width: 400px;
            z-index: 1050;
            padding: 12px;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .big-checkbox {
            width: 24px;
            height: 24px;
            accent-color: #2e7d32;
            margin-top: 2px;
        }

        .comp-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .carrier-badge {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            color: #fff;
            font-weight: bold;
            display: inline-block;
            white-space: nowrap;
        }

        .total-money-text {
            font-size: 13px;
            color: #2e7d32;
            font-weight: 700;
            margin-right: 8px;
        }

        .item-price {
            color: #d32f2f;
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 2px;
        }

        .dropdown-menu-scroll {
            max-height: 350px;
            overflow-y: auto;
        }

        .filter-section-title {
            font-size: 0.75rem;
            font-weight: 800;
            color: #6c757d;
            text-transform: uppercase;
            margin: 8px 12px 4px;
        }
    </style>
</head>
<body>
    <div id='app'>

        <div class='bg-white p-3 shadow-sm main-header' ref='mainHeader'
             :style='{ marginTop: isHeaderHidden ? (`-${headerHeight}px`) : "0px" }'>

            <div class='d-flex justify-content-between align-items-center mb-2'>
                <span class='fw-bold text-primary h5 mb-0'>SHOPEE WMS PRO</span>

                <div class='d-flex align-items-center bg-light rounded px-2 py-1 border'>
                    <i class='bi bi-dash-circle-fill text-secondary fs-5' style='cursor:pointer' @click='adjustZoom(-0.1)'></i>
                    <input type='range' class='form-range mx-2' style='width:60px' min='0.6' max='1.4' step='0.1' v-model='zoomLevel' @input='updateZoom'>
                    <i class='bi bi-plus-circle-fill text-primary fs-5' style='cursor:pointer' @click='adjustZoom(0.1)'></i>
                </div>

                <div class='btn-group'>
                    <button class='btn btn-sm' :class='currentView=="manager" ? "btn-primary" : "btn-outline-primary"' @click='currentView="manager"'>Đơn hàng</button>
                    <button class='btn btn-sm' :class='currentView=="logs" ? "btn-primary" : "btn-outline-primary"' @click='fetchLogs(); currentView="logs"'>Log</button>
                </div>
            </div>

            <div v-if='currentView === "manager"'>
                <ul class='nav nav-pills nav-fill bg-light p-1 rounded mb-2'>
                    <li class='nav-item'><a class='nav-link py-1' :class='{active: tab==="unprocessed"}' @click='tab="unprocessed"'>Chờ xử lý ({{unprocessedOrders.length}})</a></li>
                    <li class='nav-item'><a class='nav-link py-1' :class='{active: tab==="processed"}' @click='tab="processed"'>Đã xử lý ({{processedOrders.length}})</a></li>
                </ul>

                <div class='d-flex align-items-center justify-content-between pt-1'>
                    <div class='d-flex align-items-center'>
                        <div class='form-check ms-1'>
                            <input class='form-check-input big-checkbox' type='checkbox' id='checkAll' :checked='isAllSelected' @change='toggleSelectAll'>
                            <label class='form-check-label fw-bold ms-1 pt-1' for='checkAll'>Tất cả</label>
                        </div>

                        <div class='dropdown ms-2'>
                            <button class='btn btn-sm btn-light border shadow-sm dropdown-toggle' style='margin: 5px' type='button' data-bs-toggle='dropdown' data-bs-auto-close='outside'>
                                <span class='bi bi-funnel-fill' :class='{"text-primary": activeFilterCount > 0}'>Lọc</span>
                                <span v-if='activeFilterCount > 0' class='badge bg-primary ms-1'>{{activeFilterCount}}</span>
                            </button>
                            <ul class='dropdown-menu shadow p-2 dropdown-menu-scroll' style='min-width: 260px;'>

                                <div class='filter-section-title'>Trạng thái in</div>
                                <li v-for='opt in printStatusOptions' :key='opt.value' class='mb-2'>
                                    <div class='form-check d-flex align-items-center ps-0' style='cursor:pointer' @click='togglePrintStatus(opt.value)'>
                                        <input class='form-check-input big-checkbox mx-2 mt-0' type='checkbox' :value='opt.value' v-model='filterPrintStatus' @click.stop>
                                        <div class='flex-grow-1 d-flex justify-content-between align-items-center'>
                                            <span class='fw-bold' :class='opt.value === "yes" ? "text-success" : "text-secondary"'>
                                                <i class='bi' :class='opt.value === "yes" ? "bi-printer-fill" : "bi-printer"'></i> {{opt.label}}
                                            </span>
                                            <span class='badge bg-secondary rounded-pill ms-2'>{{opt.count}}</span>
                                        </div>
                                    </div>
                                </li>

                                <div class='filter-section-title mt-2'>Người soạn</div>
                                <li v-for='opt in pickerOptionsList' :key='opt.value' class='mb-1'>
                                    <div class='form-check ms-3'>
                                        <input class='form-check-input' type='checkbox' :value='opt.value' v-model='filterPickers' @click.stop>
                                        <label class='form-check-label small'>{{opt.label}}</label>
                                    </div>
                                </li>

                                <div class='filter-section-title mt-2'>Trạng thái soạn</div>
                                <li v-for='opt in statusOptionsList' :key='opt.value' class='mb-1'>
                                    <div class='form-check ms-3'>
                                        <input class='form-check-input' type='checkbox' :value='opt.value' v-model='filterStatuses' @click.stop>
                                        <label class='form-check-label small'>
                                            <i class='bi' :class='opt.icon' :style='{color: opt.color}'></i> {{opt.label}}
                                        </label>
                                    </div>
                                </li>

                                <li><hr class='dropdown-divider my-1'></li>

                                <div class='filter-section-title'>Đơn vị vận chuyển</div>
                                <li v-for='carrier in availableCarriers' :key='carrier.name' class='mb-2'>
                                    <div class='form-check d-flex align-items-center ps-0' style='cursor:pointer' @click='toggleCarrier(carrier.name)'>
                                        <input class='form-check-input big-checkbox mx-2 mt-0' type='checkbox' :value='carrier.name' v-model='filterCarriers' @click.stop>
                                        <div class='flex-grow-1 d-flex justify-content-between align-items-center'>
                                            <span class='carrier-badge' :style='{ backgroundColor: carrier.color }'>{{carrier.name}}</span>
                                            <span class='badge bg-secondary rounded-pill ms-2'>{{carrier.count}}</span>
                                        </div>
                                    </div>
                                </li>

                                <li v-if='availableCarriers.length === 0' class='text-center text-muted small py-2'>Không có dữ liệu</li>
                                <li><hr class='dropdown-divider'></li>
                                <li class='d-flex gap-2'>
                                    <button v-if='activeFilterCount > 0' class='btn btn-sm btn-outline-danger w-50' @click='clearFilters'>Xóa lọc</button>
                                    <button class='btn btn-sm btn-primary flex-grow-1' @click='closeDropdown'>Xong</button>
                                </li>
                            </ul>
                        </div>
                        <button class='btn btn-sm btn-light border shadow-sm me-2' style='margin: 5px' @click='sortDesc = !sortDesc'>
                            <i class='bi' :class='sortDesc ? "bi-sort-down" : "bi-sort-up"'></i>
                            {{ sortDesc ? 'Mới' : 'Cũ' }}
                        </button>
                    </div>

                    <div class='d-flex align-items-center'>
                        <div style='min-width: 90px; text-align: right;'>
                            <div v-if='selectedCount > 0' class='dropdown'>
                                <button class='btn btn-sm btn-success fw-bold shadow-sm dropdown-toggle' type='button' data-bs-toggle='dropdown'>
                                    Áp dụng ({{selectedCount}})
                                </button>
                                <ul class='dropdown-menu dropdown-menu-end shadow'>
                                    <li><button class='dropdown-item py-2 fw-bold' v-if='tab==="unprocessed"' @click='startPicking'><i class='bi bi-box-seam me-2'></i>Gom đơn</button></li>
                                    <li><button class='dropdown-item py-2 fw-bold' v-if='tab==="processed"' @click='printOrders'><i class='bi bi-box-seam me-2'></i>In đơn</button></li>
                                    <li><hr class='dropdown-divider'></li>
                                    <li><button class='dropdown-item py-2' @click='batchAddNote'><i class='bi bi-pencil-square me-2'></i>Ghi chú</button></li>
                                    <li><button class='dropdown-item py-2' @click='batchAssignPicker'><i class='bi bi-person-badge me-2'></i>Gán Người soạn</button></li>
                                    <li><button class='dropdown-item py-2' @click='batchAssignStatus'><i class='bi bi-check2-square me-2'></i>Gán Trạng thái</button></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if='currentView === "picking"' class='d-flex justify-content-between align-items-center'>
                <button class='btn btn-outline-secondary btn-sm' @click='currentView="manager"'>Quay lại</button>
                <span class='fw-bold fs-5'>
                    Đã nhặt: <span class='text-success'>{{ pickedQty }}</span> / {{ totalQty }}
                </span>
            </div>
        </div>

        <div class='container py-2 scroll-area' ref='scrollContainer'
             @touchstart='pullStart' @touchmove='pullMove' @touchend='pullEnd'>

            <div class='pull-refresh-loader' :class='{refreshing: isRefreshing}' :style='{height: isRefreshing ? "50px" : pullHeight + "px"}'>
                <div v-if='isRefreshing'><i class='bi bi-arrow-repeat spin-icon fs-4'></i> Đang tải...</div>
                <div v-else>
                    <i class='bi bi-arrow-down-circle pull-icon' :class='{rotate: pullHeight > 60}'></i>
                    {{ pullHeight > 60 ? 'Thả tay để tải lại' : 'Kéo xuống để tải' }}
                </div>
            </div>

            <div v-if='currentView === "manager"'>
                <div v-if='!hasToken' class='alert alert-danger mb-3 shadow-sm'>
                    <i class='bi bi-exclamation-triangle-fill'></i> Chưa kết nối Shopee!
                </div>

                <div v-for='order in filteredOrders' :key='order.OrderId'>
                    <div class='order-header' :id='"card-" + order.OrderId' :class='{active: openOrderId === order.OrderId}' @click='toggleOrder(order.OrderId)'>
                        <div class='d-flex align-items-start w-100'>

                            <input type='checkbox' class='form-check-input me-3 big-checkbox flex-shrink-0' v-model='order.Selected' @click.stop>

                            <div class='flex-grow-1 min-w-0'>
                                <div class='d-flex align-items-center flex-wrap mb-1'>
                                    <span style='font-family:monospace;font-size:1.1em'>
                                        {{order.OrderId.slice(0,-4)}}<span class='highlight-sn'>{{order.OrderId.slice(-4)}}</span>
                                    </span>
                                </div>

                                <div class='d-flex gap-2 mb-1 flex-wrap'>
                                    <span class='badge border'
                                          :style='getPickerStyle(order.Picker)'
                                          style='cursor:pointer; font-weight:500'
                                          @click.stop='cyclePicker(order)'>
                                        <i class='bi bi-person-fill me-1'></i>{{ getPickerLabel(order.Picker) }}
                                    </span>

                                    <span class='badge border'
                                          :style='getStatusStyle(order.PickingStatus)'
                                          style='cursor:pointer; font-weight:500'
                                          @click.stop='cycleStatus(order)'>
                                        <i class='bi me-1' :class='getStatusIcon(order.PickingStatus)'></i>
                                        {{ getStatusLabel(order.PickingStatus) }}
                                    </span>
                                </div>

                                <i v-if='!order.Note' class='bi bi-pencil-square text-secondary me-1' style='cursor:pointer' @click.stop='editNote(order)'></i>
                                <div v-else class='note-badge' :class='getNoteClass(order.Note)' @click.stop='editNote(order)'>
                                    <i class='bi bi-sticky-fill me-1'></i>{{order.Note}}
                                </div>
                            </div>

                            <div class='text-end ms-2 flex-shrink-0'>
                                <div class='small text-muted mb-1'>{{ formatTime(order.UpdateAt) }}</div>

                                <div class='d-flex align-items-center justify-content-end'>
                                    <span v-if='order.TotalAmount > 0' class='total-money-text'>{{formatMoney(order.TotalAmount)}}</span>
                                    <span class='badge bg-secondary rounded-pill'>{{order.Items.length}} loại</span>
                                </div>
                                <div class='mt-1 d-flex align-items-center justify-content-end'>
                                    <i v-if='order.Printed' class='bi bi-printer-fill text-success me-1' title='Đã in'></i>
                                    <span class='carrier-badge' :style='{ backgroundColor: getCarrierColor(order.ShippingCarrier) }'>
                                        {{ order.ShippingCarrier }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if='openOrderId === order.OrderId' class='order-detail-box'>
                        <div v-for='item in order.Items' class='card-item border-0 mb-1'>
                            <div class='card-body-custom'>
                                <div class='img-box' @click.stop='showProductModal(item)'>
                                    <img :src='item.ImageUrl' class='img-thumb'>
                                    <div class='zoom-icon'><i class='bi bi-eye-fill'></i></div>
                                </div>
                                <div class='info-box'>
                                    <div class='product-name'>{{item.ProductName}}</div>
                                    <div class='variation-badge'>{{item.ModelName}}</div>
                                    <div class='item-price'>{{formatMoney(item.Price)}}</div>
                                    <div v-if='item.Shelf' class='location-badge'>
                                        <i class='bi bi-geo-alt-fill'> </i>
                                        <span> Kệ {{item.Shelf}}</span>
                                        <span v-if='item.Level'> - Ngăn {{item.Level}}</span>
                                        <span v-if='item.Box'> - Thùng {{item.Box}}</span>
                                    </div>
                                </div>
                                <div class='qty-box'><span class='qty-text' :class='{red: item.Quantity > 1}'>x{{item.Quantity}}</span></div>
                            </div>
                        </div>
                        <button v-if='tab==="unprocessed"' class='btn btn-danger w-100 mt-2 fw-bold py-2' @click='confirmShip(order.OrderId)'>
                            <i class='bi bi-printer-fill'></i> CHUẨN BỊ ĐƠN
                        </button>
                        <button v-if='tab==="unprocessed"' class='btn btn-danger w-100 mt-2 fw-bold py-2'>
                            <i class='bi bi-printer-fill'></i> IN ĐƠN
                        </button>
                    </div>
                </div>

                <div v-if='filteredOrders.length === 0 && orders.length > 0' class='text-center py-5 text-muted'>
                    <i class='bi bi-funnel fs-1'></i>
                    <p class='mt-2'>Không tìm thấy đơn hàng nào phù hợp bộ lọc.</p>
                    <button class='btn btn-sm btn-outline-primary' @click='clearFilters'>Xóa bộ lọc</button>
                </div>
            </div>

            <div v-if='currentView === "picking"'>
                <div v-for='(group, shelf) in groupedBatch' :key='shelf'>
                    <div class='picking-group-header'>
                        <span><i class='bi bi-geo-alt-fill'></i>Kệ {{shelf}}</span>
                        <span class='badge bg-white text-dark'>{{group.length}} loại</span>
                    </div>
                    <div v-for='item in group' class='card-item picking-card' :class='getPickingCardClass(item)'>
                        <div class='card-body-custom'>
                            <div class='img-box' @click.stop='showProductModal(item)'>
                                <img :src='item.ImageUrl' class='img-thumb'>
                            </div>
                            <div class='info-box'>
                                <div class='product-name'>{{item.ProductName}}</div>
                                <div class='variation-badge'>{{item.ModelName}}</div>
                                <div v-if='item.Level' class='location-badge'>
                                    <i class='bi bi-geo-alt-fill'></i>
                                    <span> Ngăn {{item.Level}}</span>
                                    <span v-if='item.Box'> - Thùng {{item.Box}}</span>
                                </div>
                                <div class='small text-muted mt-1'>
                                    Đơn: <span v-for='id in item.OrderIds' class='badge bg-light text-dark border me-1'>{{id}}</span>
                                </div>
                            </div>
                            <div class='qty-box'>
                                <span class='qty-text' :class='{red: item.TotalQty > 1}'>{{item.TotalQty}}</span>
                                <input type='checkbox' class='big-checkbox mt-2' v-model='item.Picked'>
                            </div>
                        </div>
                    </div>
                </div>
                <button class='btn btn-primary btn-float-bottom shadow' @click='finishPicking'>
                    <i class='bi bi-check2-circle me-2'></i>HOÀN THÀNH
                </button>
            </div>

            <div v-if='currentView === "logs"'>
                <div class='card-item p-3'>
                    <div class='console-box'>
                        <div v-for='line in logs' class='log-line'>{{line}}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class='modal fade' id='confirmModal' tabindex='-1'>
            <div class='modal-dialog modal-dialog-centered'>
                <div class='modal-content'>
                    <div class='modal-header'>
                        <h5 class='modal-title fw-bold'>Xác nhận</h5>
                        <button type='button' class='btn-close' data-bs-dismiss='modal'></button>
                    </div>
                    <div class='modal-body'><p class='mb-0 fs-6'>{{ confirmMessage }}</p></div>
                    <div class='modal-footer'>
                        <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Hủy</button>
                        <button type='button' class='btn btn-primary fw-bold' @click='executeConfirm'>Đồng ý</button>
                    </div>
                </div>
            </div>
        </div>

        <div class='modal fade' id='productModal' tabindex='-1'>
            <div class='modal-dialog modal-dialog-centered'>
                <div class='modal-content'>
                    <div class='modal-header border-0 pb-0'>
                        <h6 class='modal-title fw-bold text-primary'>CHI TIẾT</h6>
                        <button type='button' class='btn-close' data-bs-dismiss='modal'></button>
                    </div>
                    <div class='modal-body pt-2'>
                        <div v-if='loadingModal' class='text-center py-5 text-warning'>Loading...</div>
                        <div v-else>
                            <div class='text-center mb-2'>
                                <img :src='modalItem.img'
                                     style='width:100%;height:350px;object-fit:contain;touch-action:none'
                                     class='rounded border mb-2'
                                     @touchstart='modalTouchStart'
                                     @touchend='modalTouchEnd'>
                                <h6 class='fw-bold text-dark px-2'>{{modalItem.name}}</h6>
                            </div>
                            <div class='card bg-light border-0'>
                                <div class='card-body p-0' style='max-height:120px;overflow-y:auto'>
                                    <div v-for='v in variations' class='comp-item'
                                         :class='{"bg-warning-subtle": v.name === modalItem.name}'
                                         @click='selectVariation(v)'>
                                        <img :src='v.img' style='width:40px;height:40px;border-radius:4px;margin-right:10px'>
                                        <div class='flex-grow-1 small fw-bold'>{{v.name}}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js'></script>
    <script>
        const { createApp } = Vue;

        // === CẤU HÌNH NGƯỜI SOẠN & TRẠNG THÁI ===
        const PICKER_OPTIONS = [
            { value: '', label: 'Chưa gán', color: '#f0f0f0', text: '#666' },
            { value: 'Tài', label: 'Tài', color: '#e3f2fd', text: '#0d47a1' },
            { value: 'Oanh', label: 'Oanh', color: '#f3e5f5', text: '#4a148c' },
            { value: 'My', label: 'My', color: '#e8f5e9', text: '#1b5e20' },
            { value: 'Mẹ Hà', label: 'Mẹ Hà', color: '#f5e8e8ff', text: '#5e1b1bff' }
        ];

        const STATUS_OPTIONS = [
            { value: '', label: 'Chưa soạn', color: '#6c757d', icon: 'bi-circle', bg: '#f8f9fa' },
            { value: 'dang_soan', label: 'Đang soạn', color: '#0d6efd', icon: 'bi-hourglass-split', bg: '#cfe2ff' },
            { value: 'da_soan', label: 'Đã soạn', color: '#198754', icon: 'bi-check-circle-fill', bg: '#d1e7dd' },
            { value: 'het_hang', label: 'Hết hàng', color: '#dc3545', icon: 'bi-x-octagon-fill', bg: '#f8d7da' }
        ];

        const CARRIER_COLORS = {
            'SPX Express': '#ee4d2d',
            'J&T Express': '#ec1c24',
            'Viettel Post': '#ee0033',
            'Giao Hàng Nhanh': '#00467f',
            'Ninja Van': '#c61d23',
            'Best Express': '#ff0080',
            'VNPost': '#fdb913',
            'GrabExpress': '#00b14f',
            'NowShip': '#ee2c2c',
            'Hỏa Tốc': '#ff5722'
        };

        createApp({
            data() {
                return {
                    orders: [], tab: 'unprocessed', currentView: 'manager',
                    sortDesc: false, logs: [], hasToken: false, loginUrl: '', callbackUrl: '',
                    isBatchMode: false, batchItems: [], showUnpickedHighlight: false,
                    openOrderId: null, loadingModal: false, modalItem: {}, variations: [],
                    zoomLevel: 1.0,
                    confirmMessage: '', pendingConfirmAction: null, confirmModalInstance: null,
                    pullStartY: 0, pullHeight: 0, isRefreshing: false,
                    modalTouchStartY: 0, modalTouchEndY: 0,

                    lastScrollTop: 0,
                    isHeaderHidden: false,
                    headerHeight: 0,

                    filterCarriers: [],
                    filterPrintStatus: [],
                    filterPickers: [],
                    filterStatuses: [],
                    pickerOptionsList: PICKER_OPTIONS,
                    statusOptionsList: STATUS_OPTIONS
                }
            },
            computed: {
                unprocessedOrders() { return this.orders.filter(o => o.Status === 0); },
                processedOrders() { return this.orders.filter(o => o.Status === 1); },

                currentTabList() {
                    return this.tab === 'unprocessed' ? this.unprocessedOrders : this.processedOrders;
                },

                availableCarriers() {
                    const groups = {};
                    this.currentTabList.forEach(o => {
                        const c = o.ShippingCarrier || 'Khác';
                        if (!groups[c]) groups[c] = 0;
                        groups[c]++;
                    });
                    return Object.keys(groups).map(name => ({
                        name: name,
                        count: groups[name],
                        color: this.getCarrierColor(name)
                    })).sort((a, b) => b.count - a.count);
                },

                printStatusOptions() {
                    const list = this.currentTabList;
                    const printedCount = list.filter(o => o.Printed).length;
                    const notPrintedCount = list.length - printedCount;
                    return [
                        { label: 'Đã in', value: 'yes', count: printedCount },
                        { label: 'Chưa in', value: 'no', count: notPrintedCount }
                    ];
                },

                activeFilterCount() {
                    return this.filterCarriers.length + this.filterPrintStatus.length + this.filterPickers.length + this.filterStatuses.length;
                },

                filteredOrders() {
                    let list = this.currentTabList;
                    if (this.filterCarriers.length > 0) {
                        list = list.filter(o => this.filterCarriers.includes(o.ShippingCarrier || 'Khác'));
                    }
                    if (this.filterPrintStatus.length > 0) {
                        list = list.filter(o => {
                            const isPrinted = o.Printed === true;
                            const matchYes = this.filterPrintStatus.includes('yes') && isPrinted;
                            const matchNo = this.filterPrintStatus.includes('no') && !isPrinted;
                            return matchYes || matchNo;
                        });
                    }
                    // Lọc Người soạn
                    if (this.filterPickers.length > 0) {
                        list = list.filter(o => this.filterPickers.includes(o.Picker || ''));
                    }
                    // Lọc Trạng thái soạn
                    if (this.filterStatuses.length > 0) {
                        list = list.filter(o => this.filterStatuses.includes(o.PickingStatus || ''));
                    }

                    // SẮP XẾP THEO UpdateAt
                    return [...list].sort((a, b) => this.sortDesc ? b.UpdateAt - a.UpdateAt : a.UpdateAt - b.UpdateAt);
                },
                selectedCount() { return this.orders.filter(o => o.Selected).length; },
                isAllSelected() {
                    const list = this.filteredOrders;
                    return list.length > 0 && list.every(o => o.Selected);
                },
                groupedBatch() {
                    const groups = {};
                    this.batchItems.forEach(i => {
                        const key = i.Shelf || 'chưa xác định';
                        if (!groups[key]) groups[key] = [];
                        groups[key].push(i);
                    });
                    const sortedKeys = Object.keys(groups).sort();
                    const result = {};
                    sortedKeys.forEach(k => {
                        result[k] = groups[k].sort((a, b) => {
                            const na = a.ModelName || a.ProductName || '';
                            const nb = b.ModelName || b.ProductName || '';
                            return na.localeCompare(nb);
                        });
                    });
                    return result;
                },
                totalQty() { return this.batchItems.reduce((s, i) => s + i.TotalQty, 0); },
                pickedQty() { return this.batchItems.reduce((s, i) => s + (i.Picked ? i.TotalQty : 0), 0); }
            },
            watch: {
                tab() {
                    this.orders.forEach(o => o.Selected = false);
                    this.openOrderId = null;
                    this.clearFilters();
                    this.updateHeaderHeight();
                },
                currentView() {
                    this.updateHeaderHeight();
                }
            },
            mounted() {
                this.fetchData();
                setInterval(this.fetchData, 5000);
                setInterval(this.fetchLogs, 3000);
                this.updateZoom();
                this.confirmModalInstance = new bootstrap.Modal(document.getElementById('confirmModal'));

                this.$refs.scrollContainer.addEventListener('scroll', this.handleScroll);
                window.addEventListener('resize', this.updateHeaderHeight);
                setTimeout(this.updateHeaderHeight, 500);
            },
            methods: {
                updateHeaderHeight() {
                    this.$nextTick(() => {
                        if (this.$refs.mainHeader) {
                            this.headerHeight = this.$refs.mainHeader.offsetHeight;
                        }
                    });
                },
                handleScroll(e) {
                    const currentSt = this.$refs.scrollContainer.scrollTop;
                    if (currentSt < 0) return;
                    if (currentSt < 60) {
                        this.isHeaderHidden = false;
                        this.lastScrollTop = currentSt;
                        return;
                    }
                    const diff = currentSt - this.lastScrollTop;
                    if (diff > 0) {
                        if (diff > 80 && !this.isHeaderHidden) {
                            this.isHeaderHidden = true;
                            this.lastScrollTop = currentSt;
                        } else if (this.isHeaderHidden) {
                            this.lastScrollTop = currentSt;
                        }
                    } else if (diff < 0) {
                        if (diff < -50 && this.isHeaderHidden) {
                            this.isHeaderHidden = false;
                            this.lastScrollTop = currentSt;
                        } else if (!this.isHeaderHidden) {
                            this.lastScrollTop = currentSt;
                        }
                    }
                },

                toggleCarrier(name) {
                    const idx = this.filterCarriers.indexOf(name);
                    if (idx > -1) this.filterCarriers.splice(idx, 1);
                    else this.filterCarriers.push(name);
                },
                togglePrintStatus(val) {
                    const idx = this.filterPrintStatus.indexOf(val);
                    if (idx > -1) this.filterPrintStatus.splice(idx, 1);
                    else this.filterPrintStatus.push(val);
                },
                clearFilters() {
                    this.filterCarriers = [];
                    this.filterPrintStatus = [];
                    this.filterPickers = [];
                    this.filterStatuses = [];
                },
                closeDropdown() { document.body.click(); },

                formatTime(ts) { return new Date(ts * 1000).toLocaleString('vi-VN'); },
                formatMoney(val) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(val); },
                getCarrierColor(name) {
                    if (!name) return '#6c757d';
                    for (const [key, color] of Object.entries(CARRIER_COLORS)) {
                        if (name.includes(key) || name === key) return color;
                    }
                    return '#6c757d';
                },

                // --- HELPER STYLE CHO PICKER & STATUS ---
                getPickerConfig(val) { return this.pickerOptionsList.find(x => x.value === (val || '')) || this.pickerOptionsList[0]; },
                getStatusConfig(val) { return this.statusOptionsList.find(x => x.value === (val || '')) || this.statusOptionsList[0]; },

                getPickerLabel(val) { return this.getPickerConfig(val).label; },
                getPickerStyle(val) {
                    const cfg = this.getPickerConfig(val);
                    return { backgroundColor: cfg.color, color: cfg.text, borderColor: cfg.color };
                },

                getStatusLabel(val) { return this.getStatusConfig(val).label; },
                getStatusIcon(val) { return this.getStatusConfig(val).icon; },
                getStatusStyle(val) {
                    const cfg = this.getStatusConfig(val);
                    return { backgroundColor: cfg.bg, color: cfg.color, borderColor: cfg.bg };
                },

                cyclePicker(order) {
                    const currentIdx = this.pickerOptionsList.findIndex(x => x.value === (order.Picker || ''));
                    const nextIdx = (currentIdx + 1) % this.pickerOptionsList.length;
                    const nextVal = this.pickerOptionsList[nextIdx].value;
                    order.Picker = nextVal;
                    this.apiUpdateBatch([order.OrderId], 'picker', nextVal);
                },
                cycleStatus(order) {
                    const currentIdx = this.statusOptionsList.findIndex(x => x.value === (order.PickingStatus || ''));
                    const nextIdx = (currentIdx + 1) % this.statusOptionsList.length;
                    const nextVal = this.statusOptionsList[nextIdx].value;
                    order.PickingStatus = nextVal;
                    this.apiUpdateBatch([order.OrderId], 'status', nextVal);
                },

                batchAssignPicker() {
                    let msg = "Nhập SỐ tương ứng để chọn Người soạn:\n";
                    this.pickerOptionsList.forEach((opt, idx) => { msg += ` ${idx}. ${opt.label}\n`; });
                    const input = prompt(msg);
                    const idx = parseInt(input);
                    if (!isNaN(idx) && this.pickerOptionsList[idx]) {
                        const val = this.pickerOptionsList[idx].value;
                        const ids = this.filteredOrders.filter(o => o.Selected).map(o => o.OrderId);
                        this.filteredOrders.filter(o => o.Selected).forEach(o => o.Picker = val);
                        this.apiUpdateBatch(ids, 'picker', val);
                    }
                },
                batchAssignStatus() {
                    let msg = "Nhập SỐ tương ứng để chọn Trạng thái:\n";
                    this.statusOptionsList.forEach((opt, idx) => { msg += ` ${idx}. ${opt.label}\n`; });
                    const input = prompt(msg);
                    const idx = parseInt(input);
                    if (!isNaN(idx) && this.statusOptionsList[idx]) {
                        const val = this.statusOptionsList[idx].value;
                        const ids = this.filteredOrders.filter(o => o.Selected).map(o => o.OrderId);
                        this.filteredOrders.filter(o => o.Selected).forEach(o => o.PickingStatus = val);
                        this.apiUpdateBatch(ids, 'status', val);
                    }
                },

                async apiUpdateBatch(ids, field, value) {
                    if (ids.length === 0) return;
                    try {
                        await fetch('/api/update-batch', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ Ids: ids, Field: field, Value: value })
                        });
                    } catch (e) { console.error(e); }
                },

                updateZoom() { document.body.style.zoom = this.zoomLevel; },
                adjustZoom(delta) { this.zoomLevel = Math.max(0.6, Math.min(1.4, parseFloat(this.zoomLevel) + delta)); this.updateZoom(); },

                pullStart(e) { if (this.$refs.scrollContainer.scrollTop === 0) this.pullStartY = e.touches[0].clientY; },
                pullMove(e) {
                    if (this.pullStartY > 0 && !this.isRefreshing) {
                        const y = e.touches[0].clientY;
                        const diff = y - this.pullStartY;
                        if (diff > 0) this.pullHeight = diff > 80 ? 80 : diff;
                    }
                },
                pullEnd(e) {
                    if (this.pullHeight > 60) {
                        this.isRefreshing = true;
                        this.pullHeight = 50;
                        this.fetchData().then(() => {
                            setTimeout(() => { this.isRefreshing = false; this.pullHeight = 0; }, 500);
                        });
                    } else { this.pullHeight = 0; }
                    this.pullStartY = 0;
                },

                modalTouchStart(e) { this.modalTouchStartY = e.changedTouches[0].screenY; },
                modalTouchEnd(e) { this.modalTouchEndY = e.changedTouches[0].screenY; this.handleModalSwipe(); },
                handleModalSwipe() {
                    const diff = this.modalTouchStartY - this.modalTouchEndY;
                    if (Math.abs(diff) < 50) return;
                    const currentIdx = this.variations.findIndex(v => v.name === this.modalItem.name);
                    if (currentIdx === -1) return;
                    let nextIdx = -1;
                    if (diff > 0) nextIdx = (currentIdx + 1) % this.variations.length;
                    else nextIdx = (currentIdx - 1 + this.variations.length) % this.variations.length;
                    if (nextIdx !== -1) this.selectVariation(this.variations[nextIdx]);
                },

                async fetchData() {
                    try {
                        const res = await fetch('/api/data');
                        const data = await res.json();
                        this.hasToken = data.hasToken;
                        this.loginUrl = data.loginUrl;
                        const oldMap = new Map(this.orders.map(o => [o.OrderId, o]));
                        this.orders = data.orders.map(o => {
                            const old = oldMap.get(o.OrderId);
                            return {
                                ...o,
                                Selected: old ? old.Selected : false,
                                Note: o.Note || '',
                                Printed: o.Printed || false,
                                // Load thêm 2 trường mới, nếu chưa có thì gán mặc định rỗng
                                Picker: o.Picker || '',
                                PickingStatus: o.PickingStatus || ''
                            };
                        });
                    } catch (e) { console.error(e); }
                },
                async fetchLogs() { if (this.currentView === 'logs') { const res = await fetch('/api/logs'); this.logs = await res.json(); } },
                toggleSelectAll(e) { const checked = e.target.checked; this.filteredOrders.forEach(o => o.Selected = checked); },

                toggleOrder(id) {
                    if (this.openOrderId === id) {
                        this.openOrderId = null;
                    } else {
                        this.openOrderId = id;
                        this.scrollToOrder(id);
                    }
                },

                scrollToOrder(id) {
                    this.$nextTick(() => {
                        const el = document.getElementById('card-' + id);
                        if (el) {
                            el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    });
                },

                editNote(order) {
                    const current = order.Note || '';
                    const input = prompt('Nhập ghi chú:', current);
                    if (input !== null && input !== current) {
                        order.Note = input;
                        fetch(`/api/note?id=${order.OrderId}`, { method: 'POST', body: input });
                    }
                },
                batchAddNote() {
                    const input = prompt('Nhập ghi chú cho ' + this.selectedCount + ' đơn:');
                    if (input !== null) {
                        this.orders.filter(o => o.Selected).forEach(o => {
                            o.Note = input;
                            fetch(`/api/note?id=${o.OrderId}`, { method: 'POST', body: input });
                        });
                    }
                },
                getNoteClass(note) {
                    if (!note) return '';
                    const n = note.toLowerCase();
                    if (n === 'đã soạn') return 'green';
                    if (n === 'chưa soạn') return 'red';
                    return 'normal';
                },
                getPickingCardClass(item) {
                    return { 'done': item.Picked, 'highlight-error': this.showUnpickedHighlight && !item.Picked };
                },
                showConfirm(msg, action) { this.confirmMessage = msg; this.pendingConfirmAction = action; this.confirmModalInstance.show(); },
                executeConfirm() { if (this.pendingConfirmAction) this.pendingConfirmAction(); this.confirmModalInstance.hide(); },
                confirmShip(id) { this.showConfirm('Bạn chắc chắn muốn chuẩn bị đơn này?', () => { this.shipOrder(id); }); },
                finishPicking() {
                    const unpicked = this.batchItems.filter(i => !i.Picked);
                    if (unpicked.length === 0) {
                        this.applyNoteToOrders(this.batchItems, 'Đã soạn');
                        this.closePicking();
                    } else {
                        this.showUnpickedHighlight = true;
                        this.showConfirm('Còn ' + unpicked.length + ' loại chưa nhặt. Vẫn hoàn thành và đánh dấu lỗi?', () => {
                            const picked = this.batchItems.filter(i => i.Picked);
                            this.applyNoteToOrders(picked, 'Đã soạn');
                            this.applyNoteToOrders(unpicked, 'Chưa soạn');
                            this.closePicking();
                        });
                    }
                },
                applyNoteToOrders(items, note) {
                    items.forEach(item => {
                        item.OrderIds.forEach(shortId => {
                            const order = this.orders.find(o => o.OrderId.endsWith(shortId) && o.Selected);
                            if (order) {
                                if (note === 'Đã soạn' && order.Note === 'Chưa soạn') return;
                                order.Note = note;
                                fetch(`/api/note?id=${order.OrderId}`, { method: 'POST', body: note });
                            }
                        });
                    });
                },
                closePicking() {
                    this.isBatchMode = false;
                    this.orders.forEach(o => o.Selected = false);
                    this.currentView = 'manager';
                    this.showUnpickedHighlight = false;
                },
                async shipOrder(id) {
                    let nextId = null;
                    const list = this.filteredOrders;
                    const idx = list.findIndex(x => x.OrderId === id);
                    if (idx !== -1 && idx < list.length - 1) {
                        nextId = list[idx + 1].OrderId;
                    }

                    await fetch(`/api/ship?id=${id}`, { method: 'POST' });

                    const o = this.orders.find(x => x.OrderId === id);
                    if (o) {
                        o.Status = 1;
                        o.Selected = false;
                    }

                    if (nextId) {
                        this.openOrderId = nextId;
                        this.scrollToOrder(nextId);
                    } else {
                        this.openOrderId = null;
                    }

                    try { fetch('/api/sync', { method: 'POST' }); } catch { }
                },
                printOrders() {
                    const selected = this.orders.filter(o => o.Selected);
                    selected.forEach(o => o.Printed = true);
                    alert('Đang gửi lệnh in cho ' + selected.length + ' đơn...');
                },
                startPicking() {
                    const selected = this.orders.filter(o => o.Selected);
                    if (selected.length === 0) return;
                    const agg = {};
                    selected.forEach(order => {
                        order.Items.forEach(item => {
                            const key = item.ModelName;
                            if (!agg[key]) agg[key] = {
                                ProductName: item.ProductName,
                                ModelName: item.ModelName,
                                ImageUrl: item.ImageUrl,
                                Shelf: item.Shelf,
                                Level: item.Level,
                                Box: item.Box,
                                TotalQty: 0, OrderIds: [], Picked: false,
                                ItemId: item.ItemId
                            };
                            agg[key].TotalQty += item.Quantity;
                            agg[key].OrderIds.push(order.OrderId.slice(-4));
                        });
                    });
                    this.batchItems = Object.values(agg);
                    this.currentView = 'picking';
                },
                async showProductModal(item) {
                    this.loadingModal = true;
                    this.modalItem = { name: item.ModelName, img: item.ImageUrl };
                    this.variations = [];
                    new bootstrap.Modal(document.getElementById('productModal')).show();
                    try {
                        const res = await fetch('/api/product?id=' + item.ItemId);
                        const data = await res.json();
                        if (data.success) {
                            this.variations = data.variations;
                            const current = this.variations.find(v => v.name === item.ModelName);
                            if (current) this.modalItem = { ...current, name: current.name, img: current.img };
                        }
                    } catch (e) { }
                    this.loadingModal = false;
                },
                selectVariation(v) { this.modalItem = { name: v.name, img: v.img }; }
            }
        }).mount('#app');
    </script>
</body>
</html>